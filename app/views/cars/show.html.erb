<div class="centered-columns">
  <div class="column">

    <% @ownership = @car.ownerships.find_by_user_id(current_user.id) if current_user %>

    <h2 class="car-title">
      <%= @car.car_make.name %> <%= @car.model %>
      <span class="text-muted"><%= @car.variant %></span>
      <span class="text-muted">
        (<%= @car.fuel_type.eql?("CNG") ? @car.fuel_type : @car.fuel_type.chars.first %>)
      </span>
    </h2>

    <div class="center-block">
      <div class="field text-secondary field-bold">
        Model: <%= @car.date_of_purchase.strftime("%B %Y") %>
      </div>

      <% mileage = calculate_avg_mileage(@fuel_topups)
        mileage = mileage < 0 ? '-' : "#{mileage} kmpl (avg of last 5 topups)" %>

      <div class="field mileage field-bold">
        Mileage: <%= mileage %>
      </div>

      <% if current_user && @ownership&.user_id == current_user.id %>
        <div class="field">
          <%= link_to "View Full Refill History",
              ownership_fuel_topups_path(@ownership),
              class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
    <table class="topups-table">
      <tr>
        <th>Date</th>
        <th>Fuel Brand</th>
        <th>Price</th>
        <th>Rate/Litre</th>
        <th>Odometer (kms)</th>
        <th>Mileage (kmpl)</th>
      </tr>

      <% @fuel_topups.each_with_index do |top_up, index| %>
        <tr>
          <td><%= top_up.topup_date.strftime("%d-%m-%Y") %></td>
          <td><%= top_up.brand %></td>
          <td>â‚¹<%= top_up.price %></td>
          <td>â‚¹<%= top_up.rate_per_litre %></td>
          <td><%= top_up.odometer_reading %></td>
          <td>
          <% if index == 0 %>
            <span><i class='fas fa-fire-alt' style='color:orange'></i> Burning now</span>
          <% else %>          
            <%= top_up.mileage_from(@prev_topup) %></td>
          <% end %>
          <% @prev_topup = top_up %>
        </tr>
      <% end %>
    </table>

    <div class="fuel-cards">  
      <% @fuel_topups.each_with_index do |current_topup, index| %>
        <% next_topup = @fuel_topups[index - 1] if index > 0 %>

        <%= render partial: "fuel_topups/fuel_topup",
                  locals: { current_topup: current_topup, next_topup: next_topup, index: index } %>
      <% end %>
    </div>


    <% if @fuel_topups.size < 2 %>
      <div class="field mileage">
        Add at least 2 fuel topup records to view mileage.
      </div>
    <% end %>

    <div class="center-block">
      <% if @ownership.present? %>
        <%= link_to "Topup Fuel",
            new_ownership_fuel_topup_path(@ownership),
            class: "btn btn-primary" %>
      <% end %>
      <%= link_to 'Back', cars_path, class: "btn btn-primary" %>
    </div>

    <div class="qna-box">
      <ul>
        <li class="question">ðŸ¤” How does it work?</li>
        <li class="answer">
          We calculate based on kms between your consecutive topups
        </li>
      </ul>
    </div>

  </div>
</div>
